<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Pitch Master & Key Lab</title>
    <style>
        :root {
            --bg: #121212;
            --container-bg: #1e1e1e;
            --accent: #2196F3;
            --correct: #4CAF50;
            --wrong: #f44336;
            --text: #ffffff;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
        }

        .container { 
            background: var(--container-bg); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); 
            text-align: center; 
            width: 95vw; 
            max-width: 1000px; 
        }

        #chord-display { font-size: 1.8rem; color: var(--accent); min-height: 45px; margin-bottom: 10px; font-weight: bold; }

        /* Key Signature & Accidental Controls */
        .settings-panel {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #444;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        select {
            width: 100%;
            padding: 10px;
            background: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 6px;
            cursor: pointer;
        }

        .accidental-grid { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .acc-btn {
            padding: 5px 8px;
            font-size: 0.75rem;
            background: #444;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .acc-btn.active { background: var(--accent); border-color: white; }

        .stats { display: flex; justify-content: space-around; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .stat-box { background: #2d2d2d; padding: 10px; border-radius: 12px; min-width: 100px; border: 1px solid #444; flex: 1; }
        .stat-val { font-size: 1.3rem; font-weight: bold; color: var(--correct); }

        .keyboard-wrapper { overflow-x: auto; background: #000; padding: 25px 10px; border-radius: 15px; margin: 20px 0; display: flex; }
        #keyboard { display: flex; position: relative; height: 160px; margin: 0 auto; }
        .key { border: 1px solid #888; cursor: pointer; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; font-size: 0.7rem; border-radius: 0 0 6px 6px; flex-shrink: 0; user-select: none; }
        .white { background: white; color: #333; width: 35px; height: 100%; z-index: 1; }
        .black { background: #333; color: white; width: 22px; height: 60%; margin-left: -11px; margin-right: -11px; z-index: 2; border: 1px solid #000; }
        
        .active-play { background: #90caf9 !important; border-color: #2196F3; }
        .correct { background: var(--correct) !important; }
        .wrong { background: var(--wrong) !important; }

        .controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        button { padding: 12px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-main { background: var(--correct); grid-column: span 2; }
        .btn-next { background: #ff9800; grid-column: span 2; }
        .btn-rec { background: #e91e63; }
        .btn-play-rec { background: #9c27b0; }
        .btn-download { background: #009688; }
    </style>
</head>
<body>

<div class="container">
    <div id="chord-display">Free Play Mode</div>

    <div class="settings-panel">
        <div>
            <div style="font-size: 0.8rem; margin-bottom: 5px; color: #aaa;">KEY SIGNATURE</div>
            <select id="key-sig-select">
                <option value="C">C Major (No Sharps/Flats)</option>
                <option value="G">G Major (F#)</option>
                <option value="D">D Major (F#, C#)</option>
                <option value="A">A Major (F#, C#, G#)</option>
                <option value="E">E Major (F#, C#, G#, D#)</option>
                <option value="B">B Major (F#, C#, G#, D#, A#)</option>
                <option value="F">F Major (Bb)</option>
                <option value="Bb">Bb Major (Bb, Eb)</option>
                <option value="Eb">Eb Major (Bb, Eb, Ab)</option>
            </select>
        </div>
        <div>
            <div style="font-size: 0.8rem; margin-bottom: 5px; color: #aaa;">MANUAL ACCIDENTALS</div>
            <div class="accidental-grid" id="acc-grid"></div>
        </div>
    </div>
    
    <div class="stats">
        <div class="stat-box">Correct<br><span id="score-correct" class="stat-val">0</span></div>
        <div class="stat-box">Total<br><span id="score-total" class="stat-val">0</span></div>
        <div class="stat-box">Active<br><span id="active-note-name" class="stat-val">-</span></div>
    </div>

    <div class="keyboard-wrapper"><div id="keyboard"></div></div>
    
    <div class="controls">
        <button id="play-btn" class="btn-main">üîä Repeat Target Pitch</button>
        <button id="next-btn" class="btn-next">‚è≠Ô∏è New Random Note</button>
        <button id="rec-btn" class="btn-rec">‚óè Record</button>
        <button id="stop-btn" style="background:#555;">‚ñ† Stop</button>
        <button id="play-rec-btn" class="btn-play-rec">‚ñ∂ Playback</button>
        <button id="download-btn" class="btn-download">üíæ Download</button>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const naturalBase = ["C", "D", "E", "F", "G", "A", "B"];
    
    const keySignatures = {
        "C": [], "G": ["F#"], "D": ["F#", "C#"], "A": ["F#", "C#", "G#"], 
        "E": ["F#", "C#", "G#", "D#"], "B": ["F#", "C#", "G#", "D#", "A#"],
        "F": ["Bb"], "Bb": ["Bb", "Eb"], "Eb": ["Bb", "Eb", "Ab"]
    };

    let activeAccidentals = {}; // e.g., { "F": "F#" }
    let currentFreq, currentNoteFull, hasGuessed = false, score = 0, total = 0;
    let isRecording = false, startTime = 0, recordedNotes = [];

    const keyMap = {
        '1':'C2','2':'D2','3':'E2','4':'F2','5':'G2','6':'A2','7':'B2',
        '8':'C3','9':'D3','0':'E3','q':'F3','w':'G3','e':'A3','r':'B3',
        't':'C4','y':'D4','u':'E4','i':'F4','o':'G4','p':'A4','a':'B4',
        's':'C5','d':'D5','f':'E5','g':'F5','h':'G5','j':'A5','k':'B5',
        'z':'C6','x':'D6','c':'E6','v':'F6','b':'G6','n':'A6','m':'B6'
    };

    function initAccidentals() {
        const grid = document.getElementById('acc-grid');
        naturalBase.forEach(n => {
            const btn = document.createElement('div');
            btn.className = 'acc-btn';
            btn.innerText = n + "#";
            btn.onclick = () => toggleManualAccidental(n, n + "#", btn);
            grid.appendChild(btn);
        });
    }

    function toggleManualAccidental(base, target, btn) {
        if (activeAccidentals[base] === target) {
            delete activeAccidentals[base];
            btn.classList.remove('active');
        } else {
            activeAccidentals[base] = target;
            btn.classList.add('active');
        }
    }

    document.getElementById('key-sig-select').onchange = (e) => {
        activeAccidentals = {};
        const sig = keySignatures[e.target.value];
        sig.forEach(note => {
            const base = note.substring(0, 1);
            activeAccidentals[base] = note;
        });
        // Sync UI
        document.querySelectorAll('.acc-btn').forEach(btn => {
            const base = btn.innerText.charAt(0);
            btn.classList.toggle('active', !!activeAccidentals[base]);
        });
    };

    function createKeyboard() {
        const kb = document.getElementById('keyboard');
        for (let oct = 1; oct <= 8; oct++) {
            notes.forEach((noteName) => {
                if (oct === 8 && noteName !== "C") return;
                const key = document.createElement('div');
                key.className = `key ${noteName.includes('#') ? 'black' : 'white'}`;
                key.id = `key-${noteName.replace('#', 's')}${oct}`;
                if (noteName === "C") key.innerText = "C" + oct;
                key.onmousedown = () => handleInput(noteName + oct);
                kb.appendChild(key);
            });
        }
    }

    function playTone(freq, octave, time = audioCtx.currentTime) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = (octave <= 3) ? 'triangle' : 'sine';
        osc.frequency.setValueAtTime(freq, time);
        let vol = (octave <= 2) ? 0.7 : (octave === 3) ? 0.5 : 0.25;
        gain.gain.setValueAtTime(vol, time);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 1.2);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(time); osc.stop(time + 1.2);
    }

    function handleInput(noteStr) {
        let base = noteStr.replace(/[0-9]/g, '');
        let oct = parseInt(noteStr.replace(/\D/g, ''));
        
        // Handle flats to sharps conversion for logic (Bb -> A#)
        if (activeAccidentals[base]) {
            base = activeAccidentals[base].replace('Bb', 'A#').replace('Eb', 'D#').replace('Ab', 'G#');
        }

        const freq = 440 * Math.pow(2, (notes.indexOf(base) + (oct * 12) - 57) / 12);
        playTone(freq, oct);
        document.getElementById('active-note-name').innerText = base + oct;

        const keyEl = document.getElementById(`key-${base.replace('#', 's')}${oct}`);
        if (keyEl) {
            keyEl.classList.add('active-play');
            setTimeout(() => keyEl.classList.remove('active-play'), 200);
        }

        if (isRecording) recordedNotes.push({ note: base + oct, time: Date.now() - startTime });

        if (!hasGuessed && currentNoteFull) {
            total++;
            if ((base + oct) === currentNoteFull) {
                score++;
                document.getElementById('chord-display').innerText = "Correct!";
            } else {
                document.getElementById('chord-display').innerText = "Wrong (was " + currentNoteFull + ")";
            }
            hasGuessed = true;
            document.getElementById('score-correct').innerText = score;
            document.getElementById('score-total').innerText = total;
        }
    }

    // Recording and App Initialization
    document.getElementById('rec-btn').onclick = () => { isRecording = true; recordedNotes = []; startTime = Date.now(); };
    document.getElementById('stop-btn').onclick = () => { isRecording = false; };
    document.getElementById('download-btn').onclick = () => {
        const blob = new Blob([recordedNotes.map(n => n.note).join(", ")], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'recording.txt';
        a.click();
    };
    document.getElementById('play-rec-btn').onclick = () => {
        const now = audioCtx.currentTime;
        recordedNotes.forEach(n => {
            const oct = parseInt(n.note.replace(/\D/g, ''));
            const freq = 440 * Math.pow(2, (notes.indexOf(n.note.replace(/[0-9]/g, '')) + (oct * 12) - 57) / 12);
            playTone(freq, oct, now + (n.time / 1000));
        });
    };

    function generateNote() {
        const nIdx = Math.floor(Math.random() * 12), oct = Math.floor(Math.random() * 8) + 1;
        currentNoteFull = (oct === 8) ? "C8" : notes[nIdx] + oct;
        currentFreq = 440 * Math.pow(2, (nIdx + (oct * 12) - 57) / 12);
        hasGuessed = false;
        document.getElementById('chord-display').innerText = "Identify the note...";
        playTone(currentFreq, oct);
    }

    window.addEventListener('keydown', (e) => { if (keyMap[e.key]) { e.preventDefault(); handleInput(keyMap[e.key]); } });
    document.getElementById('play-btn').onclick = () => playTone(currentFreq, parseInt(currentNoteFull.replace(/\D/g, '')));
    document.getElementById('next-btn').onclick = generateNote;

    initAccidentals(); createKeyboard(); generateNote();
</script>
</body>
</html>
